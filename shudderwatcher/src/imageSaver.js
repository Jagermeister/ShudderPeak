const fs = require('fs');
const request = require('request');
const config = require('./config.json');

const imageKeys = ["425618","553734","1","55338","580116","1615837","354","491570","1640626","1350712","453828","143778","761925","357","87","616396","64138","1629545","3792","402861","1522836","1093948","488822","963599","9","88","519985","984722","790940","790975","157543","25","738001","1517411","788264","984710","973","84608","1560128","1199606","822104","191762","191763","191764","191767","461298","1003187","1003189","58754","402543","120098","115847","11","4339","2","1609931","62833","439","1254672","58765","1009573","1175824","614315","1409309","145315","1221184","1523510","114836","62834","41","939499","33","160400","34700","1615795","28087","1544688","81248","1012394","1405594","904865","1449979","160401","156921","839340","1265577","1474312","1130539","984781","90076","877388","120079","1305262","100590","876390","1555981","1287994","1902","1556042","22639","17662","188854","445","8","1581225","984740","1601651","1120428","1555988","194823","194824","194825","805992","135916","133468","1010322","1396977","1523842","963234","650731","626795","426163","184115","360","153556","1519432","772278","1644025","120688","86","1190286","38436","497760","1623291","1138925","58741","761930","1429210","1555970","57993","611786","980171","1340316","1613710","984720","612979","1406119","775192","1404891","1555993","967449","62152","743904","746473","746478","1313136","1555961","608278","106169","1904","1265923","743875","1582115","3","116625","1158169","1158171","1158172","1613113","1581192","1581194","1582804","1582807","858728","1629531","138344","1178887","1233524","1207531","1644388","1595780","439806","245","697696","1140023","778454","1629525","1547903","10","1581185","1581191","68856","160395","1030811","12","520011","933121","933135","963686","1176025","1640230","120064","120066","120067","120068","70732","1565289","784102","115845","480045","194595","599547","1321025","119331","819891","319636","1530208","433","113514","975039","117640","18","746451","52","1557244","988596","166266","1441276","106294","1603409","1212747","1045255","34","1090060","1178891","1595357","46440","1529742","1441271","17","106293","832962","1626729","1057656","1384116","1384126","311534","425671","425688","1204050","1015280","1207074","141798","115846","944962","738018","107030","1290325","489","817299","4","1566950","1012403","190976","1338257","4057","992519","212205","212206","1288770","762002","405904","440","521050","155877","1629553","1019048","116051","134253","28","1063575","960003","785177","743892","743899","743922","878700","895066","1035672","36","120711","74510","70433","81997","115848","106233","780100","872239","966819","112291","121815","106205","107731","1426775","168930","106204","106175","244","112379","880743","880744","69","1063566","108650","143635","143636","30259","743849","6937","509598","738188","120232","987151","160404","24631","81274","44067","793922","108917","79935","1178843","822126","191447","110301","5","30","1049447","1629560","1404069","36535","112292","1406154","97724","58127","81103","1389118","4337","1000361","1287627","800332","1629561","705194","22998","146960","103048","785195","69042","6","194622","194623","1470037","1429207","1601644","1445967","1467415","1445964","118783","854657","1226804","1629546","363438","1445974","1319449","1176012","184815","1533564","1539743","650732","127055","1405533","763387","1252448","449880","185545","966822","1643617","904877","1556022","1630115","642206","14856","1554088","738126","1232583","1607019","17068","1190282","1546479","294317","958135","997588","1130807","205344","146060","1405911","76383","1629557","166174","108871","1431286","1484303","126479","102242","1387456","82820","776615","737657","1629536","78083","191313","100249","1394678","1397652","1187479","1287537","1289964","1564353","478057","1629543","1629520","1629541","1629548","409139","1639122","179995","1597801","1629522","1557252","1441289","126817","133509","128660","420049","420051","813617","1629533","1317272","1629535","1335413","81249","102130","1611444","1629528","1639124","1116700","826562","1637682","1150492","1574694","1011839","1566951","205342","1178840","1557386","1637613","106170","1558206","1558207","1028959","939496","966714","115844","121817","1578496","1176035","813614","1645874","1407495","1066466","1646903","136505","1243364","535268","535269","535272","535274","746637","746638","746641","746642","757045","757047","757049","757051","703458","7","1563063","1178884","147833","81462","996454","186146","1381860","118250","8292","69729","1612544","160402","4040","47","1462622","98562","581053","1557381","402551","1364487","1141818","426175","1612580","1572430","634990","1557250","496","1541870","446979","160403","1593730","1265775","32438","1438508","76318","108918","858224","92934","1366306","1629556","483","196892","62835","143490","137838","148782","878716","876449","1230711","1564358","1441281","136902","1523327","143156","766448","1064987","1064988","1064995","1064991","1130348","1130349","1297279","1297281","1606713","184818","118456","1048016","40619","902807","472328","903777","49106","1207397","164989","1557245","333074","1593169","834207","963604","1449814","114870","859067","117650","811310","12576","116948","1088278","1406118","1454687"];
imageKeys.push(...["36","102556","25","115845","1615584","102242","134256","114836","160401","1","3792","425671","425688","52","1650064","354","425618","145315","245","566250","191762","191767","1003187","1003189","153556","41","73393","89650","88","86","4","864205","110785","55338","1564011","1584157","1584163","1643628","1645606","22639","72596","72597","72598","1374823","1547903","115849","1326955","125293","9","120232","619823","1560519","445","216865","894243","4057","17654","1479466","117535","117536","1391756","1482768","1645608","1650058","591720","157609","1441276","1650005","1649963","1490534","272474","1650115","535337","1650117","64138","508650","29175","1650034","1411170","1369011","184115","28087","1342045","33","117751","160394","115996","84608","68960","1581886","360","1624148","809684","123171","1650068","681047","34","1253864","111700","1624140","1563550","160404","1902","1094567","100590","1424688","115847","1441281","70433","115848","446979","112290","78421","89640","173378","1565934","1572498","74510","1615087","1440123","117964","117965","212720","30259","144852","118128","81274","1643617","87649","3","32438","1254675","4339","1588322","351781","17655","28328","134251","134252","134253","97449","460130","98626","170566","170570","1441261","1648772","689083","689109","396434","121480","582540","904882","116051","116052","160400","1645874","1351139","1351147","1563567","1563568","1588666","1588667","1526320","1612548","138500","1038207","1038208","177866","1038212","1038216","118554","357","112288","112289","46531","18399","1558719","68856","1558723","597603","99160","198603","1558721","79874","1373367","439194","207348","123473","1529380","1529381","1529382","1553794","118449","118450","1303314","15530","1457861","30","28073","31021","126817","1563630","1188551","39889","1581185","1581191","1581192","1581194","1372443","1090289","1622188","112379","1612545","1393944","1338278","1338279","483","28","1563629","1085306","118126","1441271","1441273","58765","1494508","517693","1088520","684688","1368542","154686","1564358","1488225","1507003","1581893","1338267","1473450","1440449","1643607","499","181172","1054768","41374","734000","1272090","1316411","1071573","1179135","1544083","1615837","1188561","117533","117534","444572","1188559","1104127","1290570","1586389","1612580","2","8","60390","860450","483836","491363","1390406","1586385","904831","98627","177861","934643","123410","123431","904885","1640310","7674","479745","1640857","521050","1641968","1645870","494927","1586383","1341098","116625","157720","157721","1597759","441","1579166","1191283","392823","1643634","1491690","1231919","1489313","122358","494781","117895","1643615","1590262","1480416","1559460","121936","743875","622769","743895","434","119947","106293","114870","1613113","17659","146225","1582645","826190","1651240","1564353","1052247","485878","433960","433971","922505","1572725","1570921","69731","650987","415326","1450891","653082","272324","97448","103981","103983","86483","1528561","12","191763","1906","117963","68","14462","20225","1290325","1212694","71726","87843","1428527","864145","864149","1070097","93383","1486187","1496097","1140308","123433","1525480","1576382","1579377","1579400","1597201","1635654","175766","1650147","1338258","1582870","1409678","1555504","1569808","1651265","1466926","124194","206277","1037860","1094370","89641","115170","96553","1474312","426832","1611444","1447024","1573024","1613547","98284","205160","1040267","117962","116053","116055","440","1556398","1582804","1582807","2667","1647345","1278438","1278463","1647296","1647317","1647300","116256","1647333","134254","134255","634585","445172","1473280","1272489","1407849","69","1278430","1601155","1278433","1563566","1647340","1003190","1578390","1429142","1429145","1414128","708960","1446436","117388","46","49393","12152","173368","1045808","7","1093347","398294","398296","1540462","1571008","1556031","1499039","1338265","1100135","1333645","893806","1562186","1562188","65","1467173","1584743","1564343","1272487","1127006","1650306","120894","1053094","118934","118935","118936","118937","99656","650740","650742","118941","1565929","1637965","904866","1038542","115233","1443119","162456","650738","650739","424589","48184","668583","707397","963604","610520","86313","1174647","73269","100295","37988","49026","1594563","960583","1640230","904337","904346","1558206","1558207","62401","1558208","1558210","1483192","116435","35451","1619739","1599996","117608","1385514","127061","442130","1600991","147833","1334340","1458522","1638393","1638603","109603","1414556","1414558","1414560","791543","492","1385604","81273","79142","23405","732541","79976","168730","1491210","758361","1576449","1243364","17656","863296","1267155","1447227","472247","472250","1605626","122086","1647511","173995","518348","518350","1475590","104905","24652","17","52612","1578746","829507","740965","612254","1558488","881372","5","1339393","864063","830563","166266","1647292","80481","1560969","1529830","1627576","1564365","47","747731","1623364","1615795","1368546","1648984","401176","1573421","1625636","89232","145662","1565952","160395","125514","96006","96304","191764","1641870","1304232","1648882","709415","1317272","1643619","1527789","1643606","95853","1642709","1642710","796745","1592736","955757","1498556","1331378","1503213","115846","81103","1498569","453828","1446444","545383","160403","1631917","1592801","788264","1470037","16","121757","121758","788233","1195139","192335","195808","292189","735973","1273574","1548780","1564530","1637809","1112949","43979","948953","993812","1581808","1428824","833538","197785","1498552","1156805","1156806","1156807","1156810","1038276","128752","116967","1197342","508653","73274","489","1236716","1539211","637329","1004318","1446411","1575108","1900","323125","81636","67871","108513","1528834","182094","119939","1525081","765910","122431","1591716","1268206","1268207"]);
imageKeys.push(...["245","52","425618","25","809684","1457861","1650068","10133","1350394","1612548","86","715328","1304232","28","88","1529995","1904","28087","71726","153556","1559487","33","360319","166317","58765","1653178","100590","160401","357","64138","3792","8","1","959018","4057","1479466","3","9","89641","1643615","354","1188548","445","216865","1199071","73171","81249","1612580","1657789","667207","360","120232","81274","1581310","1581312","1650115","667206","194622","194623","55338","1064991","1470037","1584743","1645866","1645870","1645874","1657235","1290325","1221184","1297279","1297281","4339","41","1645606","1500011","904857","116051","97449","145315","22639","116435","1003190","36391","89640","426175","1156807","1156810","1590832","360542","73393","12","2","84608","904825","1003187","1003189","3668","818561","1541766","521050","239535","1059606","191313","1593360","115233","160400","160404","508650","1581886","114836","1621098","98627","1071818","410787","36","743904","1391913","69","1613113","10","1650117","1653176","1528788","1279941","376765","1563913","209959","1652303","1245848","1529152","1652304","106293","1630387","1630400","499","904856","1578589","440","1902","121257","123171","99160","62833","1547903","743875","6","123473","17659","117957","1637342","425671","425688","1466812","51711","51714","17656","1334978","1280239","1460063","1069888","1554643","1554645","1554646","1554647","166266","904882","444572","1376805","1217039","17654","432637","1591702","30259","1652040","1652041","1652042","1637363","1637360","1554215","29175","34","115848","79874","123431","441","432638","117964","117965","118449","118450","118554","904866","81103","65","124498","112288","112289","1003225","74510","18399","97448","820098","112291","398296","1615087","1516817","1441261","1441276","489835","1615795","1559484","119946","62836","106294","1445106","157609","1656862","1656863","173707","492","73269","1405347","1338261","66","789721","1498659","1017856","130711","1507003","656334","1267349","656333","656421","68856","115846","1569808","58127","1293167","106926","821920","904824","85006","1637613","34845","434","109603","1643617","1575108","1575110","1643618","108650","98284","904880","49106","105480","196892","1340434","1427215","1487882","637329","1004318","904870","181282","181291","1317272","938129","1565958","1572248","17","1656864","1656865","116053","116055","116052","1565960","396579","1605903","1565935","60257","1565952","1600969","476110","122007","140956","160703","122008","160704","160705","17655","1446411","1361610","11","1480416","111700","461298","1643645","1591056","1272487","7","13","1122519","1564353","1404635","1640230","881173","901433","1252445","192111","680379","194823","194824","194825","191762","191763","191764","191767","815255","1558719","1558721","1558723","1474104","134819","1482768","1563566","1558478","1052247","1611444","557279","1389081","111119","107030","81636","1338278","1338279","1643619","1600991","1647300","5","112290","1491210","1558702","81248","30","203287","39889","118141","122358","7676","1441271","1441273","1441281","1398377","684688","118140","1156805","1156806","942502","177845","180847","28328","87315","182125","1659687","1659693","1659695","460090","124420","1058619","1582804","1582807","161718","118493","197416","212603","324155","1630407","89678","456294","508653","508664","508669","508670","567101","1006811","1571674","1494508","206952","7460","1084503","114075","130985","130986","130987","124330","436","62260","177861","43979","1559460","1055594","1560519","1338265","904885","1278442","1417948","1643610","1338270","79340","1338269","128641","973337","973339","1659701","555717","1657237","689109","121480","446979","112292","904873","1338273","1652013","31097","966822","1657456","1659365","55475","904821","1615584","1643606","1650147","1657457","1659219","984720","132623","132624","1386091","96104","1064995","12152","173368","1045808","1407849","1409678","858728","1360600","1576962","1271995","126982","1607019","1242116","1242230","1070097","67871","402543","1592745","96553","1330451","1413579","535260","1643634","1906","88402","84499","1458397","1519434","173372","1592802","1188551","439762","70433","180945","1516928","118936","118937","1612545","117009","118250","1513455","934675","1279953","822104","1041226","313047","1016291","187978","177866","157720","157721","708024","112379","1206536","160394","113774","113789","645174","123433","1237826","1005625","1005628","1622188","30134","315950","981981","1506782","1405282","21738","110734","1640392","123409","743899","1545449","1572725","1069919","1566584","1445652","864108","1564354","1651265","1643607","1544083","160396","192363","1654847","74828","74829","152652","584222","973326","900440","1298525","1315913","1487748","863358","513522","1392060","1338277","878626","591573","591576","117075","152654","1581893","904871","336974","117962","60390","364904","1393944","1088462","159698","650740","650742","820753","650738","650739","1565934","541428","1572498","1232052","675036"]);

const existingImageKeys = new Set();
new Promise((resolve, reject) => fs.readdir('../images', (err, files) => err ? reject(err) : resolve(files)))
    .then(files => files.forEach(file => existingImageKeys.add(+file.substr(0, file.indexOf('.')))))
    .then(() => fetchUnsavedImages());

const imageMaxCount = imageKeys.length;
let currentImageIndex = 0;
function fetchUnsavedImages() {
    const key = imageKeys[currentImageIndex];
    const isExisting = existingImageKeys.has(+key);
    console.log(currentImageIndex, key, isExisting);

    if (!isExisting) {
        request.get(config.imageEndpoint.replace('{id}', key))
            .pipe(fs.createWriteStream(`../images/${key}.png`));
    }

    currentImageIndex++;
    if (currentImageIndex < imageMaxCount) {
        setTimeout(fetchUnsavedImages, isExisting ? 0 : 1000);
    }
}